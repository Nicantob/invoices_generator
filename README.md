# invoices generator
#### Код: AndrejPress (Коваленко А.В.) 11.2023 - 02.2024 в рамках практики УИИ (разработка OCR AI)
https://github.com/yenotas/invoices_generator/
####
Генератор тестовых данных и изображений счетов с искажениями, шумами и печатями, 
для тестирования и обучения системы распознавания документов. 
Библиотека имитации отсканированных документов, с хранением данных 
(по которым строятся счета) в "generated_data.json". 
В JSON при построении SVG-файлов и искажениях дописываются координаты центров и размеров надписей,
координаты печатей, названия и координаты углов геометрических искажений.

##### Что делает:

- Универсальная генерация "осмысленных" данных для бухгалтерских документов в JSON из нескольких CSV файлов с данными.
- Создание SVG файлов с текстами и таблицами по данным из JSON на основе шаблона SVG в пакетном режиме (шаблон SVG предварительно должен быть очищен и размечен вручную под необходимые для заполнения поля)
- SVG -> PNG конвертация на основе стандартных библиотек PIL и Numpy, без дополнительных костылей, с учетом различных шрифтов и начертаний (наклонное, жирное), который не сложно сделать еще более универсальным для любых документов с текстами и  таблицами (или скорректировать под другие задачи).
- Создание круглых печатей по данным из JSON
- Создание и наложение некоторых искажений и эффектов на растровые документы
- Проверка правильности вставки текстовых данных в шаблоны и в JSON и безошибочное отображение областей вставки текста ('bbox')', независимо от шрифтов и начертаний.

Все операции создания и искажения документов фиксируются также в едином JSON-файле данных, для удобного развертывания и отслеживания ошибок распознавания нейронкой.
Бонусом идут некоторые утилиты, которые остались в проекте ('\tools'): 
- конвертация и встраивание шрифта в SVG
- обработка текстовых данных в больших CSV файлах (автоматизация предобработки)
- распаковка групп тегов <g> в SVG с пересчетом координат указанных матрицей в обычные координаты текста и линий без группировки

+ Google Colab можно посмотреть здесь: https://colab.research.google.com/drive/1EoSH5U47JjVky1Nx9GAZFMcN1FiUgp0h?usp=sharing

### Использование:
#### В "config.py":
- можно указать количество генерируемых файлов,
- качество и масштабирование изображений, 
- скорректировать размер печати, 
- изменить валюту счета, 
- включить сохранение фрагментов вставок в папку generated_files/text_fragments (save_text_fragments = 1), 
для визуальной сверки генерируемых текстовых вставок в растре,
- включить принудительное использование только указанного шрифта (TEST_FONT_NAME = 'Arial') 
#### В папке "examples": 
- скрипты, поочередно запуская которые (по номерам),
можно создать "generated_data.json" и заполнить все папки генерациями - от шаблонов SVG 
до изображений JPEG с искажениями и добавленными круглыми печатями.
Папка "generated_files" и соответствующие поддиректории, с генерируемыми файлами, 
создаются скриптами.
#### В папке "tools": 

- bbox_viewer - визуализация записанных координат и размеров вставок (! используется только после шагов 01-03, 
когда сгенерированные счета сконвертированы в растр !), результат разметки сохраняется в папку 
generated_files/markup_images

- font_to_svg_insider - внедрение шрифта в SVG файл (осталось на память, не используется),

- svg_inner_coordinares_corrector - распаковка контейнеров SVG в список тегов с пересчитанными координатами, 
для упрощения расчетов координат надписей (не используется)

- text_cleaning - заготовка для быстрой очистки больших файлов по регулярным выражениям и готовым методам

#### Конвертации SVG-файлов в PNG:
Собственный конвертер на стандартном PIL для svg сгенерированных в проекте по установленному шаблону

Для установки библиотек:
+ pip install -r requirements.txt

Для установки шрифтов 
+ В директорию data/fonts/.. в каждую папку скопировать файл шрифта (.ttf)
соответствующего стиля с одним и тем же именем, убрав из названия какие-либо уточнения, 
 типа "bold" "bolditalic" "regular", оставив только имя. 
+ В папки "italic" "bolditalic" шрифт сохранять не обязательно, если не требуется его применение в наклонном стиле,
но папка "bold" должна быть по составу абсолютно такая же как и "regular", с той лишь разницей, 
что под одинаковыми именами скрывается один шрифт различного начертания.
+ Не все шрифты в силу особенностей будут верно интерпретированы при записи координат в JSON. Поэтому, 
для тестирования добавленного шрифта можно указать в config.py TEST_FONT_NAME = 'Font' 
(где 'Font' - имя файла шрифта, например 'Arial') - тогда все SVG-генерации будут использовать только этот шрифт.
Затем, после конвертации SVG->PNG с помощью bbox_viewer можно быстро проверить насколько точно записаны размеры текстовых вставок и координаты.


#### Google Colab:
+ !git clone https://github.com/yenotas/invoices_generator.git
+ %cd /content/invoices_generator
+ !pip install -r requirements.txt
+ restart session
+ %cd /content/invoices_generator/examples
+ !python 01_generation_json_data_example.py      # сгенерировать данные для счетов
+ !python 02_generation_svg_from_json_example.py  # создать шаблоны SVG
+ !python 03_conversion_svg2png_example.py        # конвертировать SVG в PNG
+ !python 04_generation_stamps_example.py         # сгенерировать печати
+ !python 05_distortions_and_stamping_example.py  # создать искажения и наложить печати
+ %cd /content/invoices_generator/tools/
+ !python bbox_viewer.py                          # Посмотреть разметку bbox-ов





